{{!-- templates/dialogs/spellbook-settings.hbs - Improved structure --}}

<div class="spellbook-settings-form">
  <h2>{{localize 'SPELLBOOK.Settings.Title' name=actor.name}}</h2>

  {{!-- Global Rule Set Override - Using fieldset --}}
  <fieldset class="settings-fieldset rule-set-fieldset">
    <legend>{{localize 'SPELLBOOK.Settings.GlobalRules'}}</legend>

    <div class="setting-row">
      <label for="rule-set-override">{{localize 'SPELLBOOK.Settings.RuleSetOverride.Label'}}</label>
      <i class="fas fa-question-circle setting-tooltip"
        data-tooltip="{{localize 'SPELLBOOK.Settings.RuleSetOverride.Hint'}}"></i>
      <select id="rule-set-override" name="ruleSetOverride">
        <option value="global" {{#unless ruleSetOverride}}selected{{/unless}}>
          {{localize 'SPELLBOOK.Settings.RuleSetOverride.Global'}} ({{currentRuleSetLabel}})
        </option>
        <option value="{{RULE_SETS.LEGACY}}" {{#if (eq ruleSetOverride RULE_SETS.LEGACY)}}selected{{/if}}>
          {{localize 'SPELLBOOK.Settings.SpellcastingRuleSet.Legacy'}}
        </option>
        <option value="{{RULE_SETS.MODERN}}" {{#if (eq ruleSetOverride RULE_SETS.MODERN)}}selected{{/if}}>
          {{localize 'SPELLBOOK.Settings.SpellcastingRuleSet.Modern'}}
        </option>
      </select>
    </div>

    <div class="setting-row">
      <label for="enforcement-behavior">{{localize 'SPELLBOOK.Settings.EnforcementBehavior.Label'}}</label>
      <i class="fas fa-question-circle setting-tooltip"
        data-tooltip="{{localize 'SPELLBOOK.Settings.EnforcementBehavior.Hint'}}"></i>
      <select id="enforcement-behavior" name="enforcementBehavior">
        <option value="global" {{#unless enforcementBehavior}}selected{{/unless}}>
          {{localize 'SPELLBOOK.Settings.EnforcementBehavior.Global'}}
        </option>
        <option value="{{ENFORCEMENT_BEHAVIOR.UNENFORCED}}"
          {{#if (eq enforcementBehavior ENFORCEMENT_BEHAVIOR.UNENFORCED)}}selected{{/if}}>
          {{localize 'SPELLBOOK.Cantrips.BehaviorUnenforced'}}
        </option>
        <option value="{{ENFORCEMENT_BEHAVIOR.NOTIFY_GM}}"
          {{#if (eq enforcementBehavior ENFORCEMENT_BEHAVIOR.NOTIFY_GM)}}selected{{/if}}>
          {{localize 'SPELLBOOK.Cantrips.BehaviorNotifyGM'}}
        </option>
        <option value="{{ENFORCEMENT_BEHAVIOR.ENFORCED}}"
          {{#if (eq enforcementBehavior ENFORCEMENT_BEHAVIOR.ENFORCED)}}selected{{/if}}>
          {{localize 'SPELLBOOK.Cantrips.BehaviorEnforced'}}
        </option>
      </select>
    </div>
  </fieldset>

  {{!-- Per-Class Settings - Using fieldset --}}
  {{#if spellcastingClasses.length}}
    <fieldset class="settings-fieldset class-rules-fieldset">
      <legend>{{localize 'SPELLBOOK.Settings.ClassRules.Title'}}</legend>
      <p class="fieldset-description">{{localize 'SPELLBOOK.Settings.ClassRules.Description'}}</p>

      {{#each spellcastingClasses as |classData|}}
        <div class="class-settings-section" data-class="{{classData.identifier}}">
          <div class="class-header">
            {{#if classData.img}}
              <img src="{{classData.img}}" alt="{{classData.name}}" class="class-icon">
            {{/if}}
            <h4>{{classData.name}}</h4>
            <div class="class-stats">
              {{#if classData.rules.showCantrips}}
                <span
                  class="cantrip-count">{{localize 'SPELLBOOK.Settings.CantripsKnown' current=classData.stats.currentCantrips max=classData.stats.maxCantrips}}</span>
              {{/if}}
              <span class="preparation-bonus {{#if (ne classData.rules.preparationBonus 0)}}has-bonus{{/if}}">
                {{#if (gt classData.rules.preparationBonus 0)}}+{{classData.rules.preparationBonus}}{{else if (lt classData.rules.preparationBonus 0)}}{{classData.rules.preparationBonus}}{{else}}±0{{/if}}
                {{localize 'SPELLBOOK.Settings.PreparationBonus.Text'}}
              </span>
            </div>
          </div>

          <div class="class-settings-list">
            {{!-- Show Cantrips Setting --}}
            <div class="setting-row">
              <label
                for="show-cantrips-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.ShowCantrips.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.ShowCantrips.Hint'}}"></i>
              <input type="checkbox" id="show-cantrips-{{classData.identifier}}"
                name="class.{{classData.identifier}}.showCantrips" {{#if classData.rules.showCantrips}}checked{{/if}}>
            </div>

            {{!-- Cantrip Swapping Setting --}}
            <div class="setting-row {{#unless classData.rules.showCantrips}}disabled{{/unless}}">
              <label
                for="cantrip-swapping-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.CantripSwapping.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.CantripSwapping.Hint'}}"></i>
              <select id="cantrip-swapping-{{classData.identifier}}"
                name="class.{{classData.identifier}}.cantripSwapping"
                {{#unless classData.rules.showCantrips}}disabled{{/unless}}>
                <option value="{{CANTRIP_SWAP_TIMING.NONE}}"
                  {{#if (eq classData.rules.cantripSwapping CANTRIP_SWAP_TIMING.NONE)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.CantripSwapping.None'}}
                </option>
                <option value="{{CANTRIP_SWAP_TIMING.LEVEL_UP}}"
                  {{#if (eq classData.rules.cantripSwapping CANTRIP_SWAP_TIMING.LEVEL_UP)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.CantripSwapping.LevelUp'}}
                </option>
                <option value="{{CANTRIP_SWAP_TIMING.LONG_REST}}"
                  {{#if (eq classData.rules.cantripSwapping CANTRIP_SWAP_TIMING.LONG_REST)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.CantripSwapping.LongRest'}}
                </option>
              </select>
            </div>

            {{!-- Spell Swapping Setting --}}
            <div class="setting-row">
              <label
                for="spell-swapping-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.SpellSwapping.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.SpellSwapping.Hint'}}"></i>
              <select id="spell-swapping-{{classData.identifier}}" name="class.{{classData.identifier}}.spellSwapping">
                <option value="{{SPELL_SWAP_MODES.NONE}}"
                  {{#if (eq classData.rules.spellSwapping SPELL_SWAP_MODES.NONE)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.SpellSwapping.None'}}
                </option>
                <option value="{{SPELL_SWAP_MODES.LEVEL_UP}}"
                  {{#if (eq classData.rules.spellSwapping SPELL_SWAP_MODES.LEVEL_UP)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.SpellSwapping.LevelUp'}}
                </option>
                <option value="{{SPELL_SWAP_MODES.LONG_REST}}"
                  {{#if (eq classData.rules.spellSwapping SPELL_SWAP_MODES.LONG_REST)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.SpellSwapping.LongRest'}}
                </option>
              </select>
            </div>

            {{!-- Ritual Casting Setting --}}
            <div class="setting-row">
              <label
                for="ritual-casting-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.RitualCasting.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.RitualCasting.Hint'}}"></i>
              <select id="ritual-casting-{{classData.identifier}}" name="class.{{classData.identifier}}.ritualCasting">
                <option value="{{RITUAL_CASTING_MODES.NONE}}"
                  {{#if (eq classData.rules.ritualCasting RITUAL_CASTING_MODES.NONE)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.RitualCasting.None'}}
                </option>
                <option value="{{RITUAL_CASTING_MODES.PREPARED}}"
                  {{#if (eq classData.rules.ritualCasting RITUAL_CASTING_MODES.PREPARED)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.RitualCasting.Prepared'}}
                </option>
                <option value="{{RITUAL_CASTING_MODES.ALWAYS}}"
                  {{#if (eq classData.rules.ritualCasting RITUAL_CASTING_MODES.ALWAYS)}}selected{{/if}}>
                  {{localize 'SPELLBOOK.Settings.RitualCasting.Always'}}
                </option>
              </select>
            </div>

            {{!-- Custom Spell List Setting --}}
            <div class="setting-row">
              <label
                for="custom-spell-list-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.CustomSpellList.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.CustomSpellList.Hint'}}"></i>
              <select id="custom-spell-list-{{classData.identifier}}"
                name="class.{{classData.identifier}}.customSpellList">
                {{#each ../availableSpellLists as |option|}}
                  <option value="{{option.value}}"
                    {{#if (eq option.value classData.rules.customSpellList)}}selected{{/if}}>
                    {{option.label}}
                  </option>
                {{/each}}
              </select>
            </div>

            {{!-- Preparation Bonus Setting --}}
            <div class="setting-row">
              <label
                for="preparation-bonus-{{classData.identifier}}">{{localize 'SPELLBOOK.Settings.PreparationBonus.Label'}}</label>
              <i class="fas fa-question-circle setting-tooltip"
                data-tooltip="{{localize 'SPELLBOOK.Settings.PreparationBonus.Hint'}}"></i>
              <div class="preparation-bonus-controls">
                <button type="button" class="prep-bonus-decrease" data-class="{{classData.identifier}}"
                  data-action="decreasePrepBonus">−</button>
                <input type="number" id="preparation-bonus-{{classData.identifier}}"
                  name="class.{{classData.identifier}}.preparationBonus" value="{{classData.rules.preparationBonus}}"
                  min="-10" max="20" class="prep-bonus-input">
                <button type="button" class="prep-bonus-increase" data-class="{{classData.identifier}}"
                  data-action="increasePrepBonus">+</button>
              </div>
            </div>
          </div>
        </div>
      {{/each}}
    </fieldset>
  {{/if}}

  {{!-- Submit Button --}}
  <div class="submit-section">
    <button type="submit" name="submit" class="submit-button">
      <i class="fas fa-save"></i> {{localize 'SPELLBOOK.Settings.SaveButton'}}
    </button>
  </div>
</div>
